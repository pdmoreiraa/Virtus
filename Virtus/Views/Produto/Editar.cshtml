@model Virtus.Models.Produto

<div class="row">
    <div class="col-md-8 mx-auto rounded border p-3">
        <h2 class="text-center mb-5">Editar Produto</h2>


        <form asp-action="Editar" method="post" enctype="multipart/form-data">
            <input type="hidden" asp-for="PrdId" />

            <div class="row mb-3">
                <label class="col-sm-4 col-form-label">Id</label>
                <div class="col-sm-8">
                    <input class="form-control-plaintext" readonly value="@Model.PrdId">
                </div>
            </div>

            <div class="row mb-3">
                <label for="Nome" class="col-sm-4 col-form-label">Nome</label>
                <div class="col-sm-8">
                    <input id="PrdNome" class="form-control" asp-for="PrdNome">
                    <span asp-validation-for="PrdNome" class="text-danger"></span>
                </div>
            </div>

            <div class="row mb-3">
                <label for="Marca" class="col-sm-4 col-form-label">Marca</label>
                <div class="col-sm-8">
                    <select class="form-select" name="PrdMarca" asp-for="PrdMarca">
                        <option value='Adidas'>Adidas</option>
                        <option value='Fila'>Fila</option>
                        <option value='Nike'>Nike</option>
                        <option value='Puma'>Puma</option>
                    </select>
                    <span asp-validation-for="PrdMarca" class="text-danger"></span>
                </div>
            </div>

            <div class="row mb-3">
                <label for="Categoria" class="col-sm-4 col-form-label">Categoria</label>
                <div class="col-sm-8">
                    <select id="PrdCategoria" name="PrdCategoria" class="form-select" asp-for="PrdCategoria">
                        <option value='Masculino'>Masculino</option>
                        <option value='Feminino'>Feminino</option>
                        <option value='Infantil'>Infantil</option>
                        <option value='Esportes'>Esportes</option>
                    </select>
                </div>
            </div>

            <div class="row mb-3">
                <label for="Tipo" class="col-sm-4 col-form-label">Tipo</label>
                <div class="col-sm-8">
                    <select id="PrdTipo" name="PrdTipo" class="form-select" asp-for="PrdTipo">
                        <option value='Acessório'>Acessório</option>
                        <option value='Agasalho'>Agasalho</option>
                        <option value='Bermuda'>Bermuda</option>
                        <option value='Calça'>Calça</option>
                        <option value='Calçado'>Calçado</option>
                        <option value='Camisa de Time'>Camisa de Time</option>
                        <option value='Camiseta'>Camiseta</option>
                        <option value='Equipamento'>Equipamento</option>
                        <option value='Shorts'>Shorts</option>
                        <option value='Top'>Top</option>
                    </select>
                </div>
            </div>

            @foreach (var estoque in Model.Estoques)
            {
                <div class="row estoque-item mb-2">
                    <input type="hidden" name="@estoque.EstTamanho" value="@estoque.EstTamanho" />

                    <div class="row mb-3">
                        <div class="col-sm-8">
                        <input type="text"
                               class="form-control"
                               value="@estoque.EstTamanho"
                               readonly />
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-sm-8">
                        <input type="number"
                               class="form-control"
                               name="@estoque.EstQuantidade"
                               value="@estoque.EstQuantidade" />
                        </div>
                    </div>
                </div>
            }

            <div id="tamanho-div"></div>

            <template id="tamanhos" class="d-none">
                <div class="row mb-3">
                    <label class="col-sm-4 col-form-label">Tamanho</label>
                    <div class="col-sm-8">
                        <select class="form-select tamanho-select">
                            <option value="">Selecione...</option>
                        </select>
                    </div>
                </div>

                <div class="row mb-3">
                    <label class="col-sm-4 col-form-label">Estoque</label>
                    <div class="col-sm-8">
                        <input class="form-control estoque-input" type="number">
                    </div>
                </div>

                <div class="mb-3 d-flex justify-content-end">
                    <button type="button" class="btn btn-danger remover">Remover</button>
                </div>

            </template>

            <div class="mb-3 d-flex justify-content-end">
                <button type="button" id="Add" class="btn btn-dark smooth-btn">
                    Adicionar tamanho e quantidade
                </button>
            </div>

            <div class="row mb-3">
                <label for="Tipo" class="col-sm-4 col-form-label">Esporte</label>
                <div class="col-sm-8">
                    <select id="PrdEsporte" name="PrdEsporte" class="form-select" asp-for="PrdEsporte">
                        <option value='Corrida'>Corrida</option>
                        <option value='Futebol'>Futebol</option>
                        <option value='Vôlei'>Vôlei</option>
                        <option value='Basquete'>Basquete</option>
                    </select>
                </div>
            </div>

            <div class="row mb-3">
                <label for="Preco" class="col-sm-4 col-form-label">Preço (R$)</label>
                <div class="col-sm-8">
                    <input id="Preco" name="PrdPreco" asp-for="PrdPreco" class="form-control" type="text" placeholder="0,00" />
                    <span asp-validation-for="PrdPreco" class="text-danger"></span>
                </div>
            </div>

            <div class="row mb-3">
                <label for="Descricao" class="col-sm-4 col-form-label">Descrição</label>
                <div class="col-sm-8">
                    <textarea id="PrdDescricao" name="PrdDescricao" class="form-control" asp-for="PrdDescricao"></textarea>
                    <span asp-validation-for="PrdDescricao" class="text-danger"></span>
                </div>
            </div>

            <div class="row mb-3">
                @foreach (var img in Model.Imagens.OrderBy(i => i.PimgOrdemImagem))
            {
                    <div class="card" data-imagem-id="@img.PimgId" style="width: 10rem;">
                        <img src="@Url.Content("~/img/" + img.PimgUrl)" class="card-img-top" alt="Imagem do produto">
                        <div class="card-body text-center">
                            <button type="button" class="btn btn-dark smooth-btn mt-1" onclick="removerImagem(@img.PimgId)">
                                Remover
                            </button>
                        </div>
                    </div>
                }
            </div>

            <div class="row mb-3">
                <label for="imagemArquivo" class="col-sm-4 col-form-label">Imagem</label>
                <div class="col-sm-8">
                    <input id="imagensArquivo" type="file" class="form-control" name="imagensArquivo" multiple accept="image/*">
                    <span asp-validation-for="Imagens" class="text-danger"></span>
                </div>
            </div>

            <div class="row mb-3">
                <label for="Descricao" class="col-sm-4 col-form-label">Cor</label>
                <div class="col-sm-8">
                    <input class="form-control" id="PrdCor" name="PrdCor" class="form-control" asp-for="PrdCor" />
                    <span asp-validation-for="PrdCor" class="text-danger"></span>
                </div>
            </div>

            <div class="row mb-3">
                <label for="DataCriada" class="col-sm-4 col-form-label">Data Criação</label>
                <div class="col-sm-8">
                    <input id="PrdData" class="form-control-plaintext" readonly value="@Model.PrdData.ToString("dd/MM/yyyy")">
                </div>
            </div>

            <div class="row">
                <div class="offset-sm-4 col-sm-4 d-grid">
                    <button type="submit" class="btn btn-dark w-100 mt-3 smooth-btn">Salvar</button>
                </div>
                <div class="col-sm-4 d-grid">
                    <a class="btn btn-light border border-dark rounded w-100 mt-3 smooth-btn" asp-controller="Produto" asp-action="Index" role="button">
                        Cancelar
                    </a>
                </div>
            </div>
        </form>
    </div>
</div>


@section Scripts {
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const precoInput = document.getElementById("Preco");

            // Valor inicial formatado
            if (!precoInput.value) {
                precoInput.value = "0,00";
            }

            precoInput.addEventListener("input", function (e) {
                let value = e.target.value;

                // Remove tudo que não for número
                value = value.replace(/\D/g, "");

                // Se vazio, assume 0
                if (value === "") {
                    value = "0";
                }

                // Converte para centavos e insere a vírgula
                value = (parseInt(value) / 100).toFixed(2);

                // Substitui ponto por vírgula
                value = value.replace(".", ",");

                e.target.value = value;
            });

            // Garante o formato correto ao perder o foco
            precoInput.addEventListener("blur", function (e) {
                if (e.target.value === "" || e.target.value === "0") {
                    e.target.value = "0,00";
                }
            });
        });

                function removerImagem(imagemId) {
            if (!confirm("Deseja realmente remover esta imagem?")) return;

            const formData = new FormData();
            formData.append("id", imagemId); // parâmetro enviado ao controller

            fetch('@Url.Action("RemoverImagem", "Produto")', {
                method: 'POST',
                body: formData
            })
            .then(res => res.json())
            .then(data => {
                if (data.sucesso) {
                    const imgCard = document.querySelector(`[data-imagem-id='${imagemId}']`);
                    if (imgCard) imgCard.remove(); // remove só o card da imagem
                } else {
                    alert(data.mensagem || "Erro ao remover imagem.");
                }
            })
            .catch(err => {
                console.error(err);
                alert("Erro de comunicação com o servidor.");
            });
        }

        let index = 0;

        const tamCalcado = ["36","37","38","39","40","41","42"];
        const tamAcessorio = ["Único"];
        const tamRoupa = ["P","M","G","GG"];

        document.getElementById("Add").addEventListener("click", () => {

            const tipos = document.getElementById("Tipo").value;

            let opcoes = [];
            if (tipos === "Calçado") opcoes = tamCalcado;
            else if (tipos === "Acessório") opcoes = tamAcessorio;
            else opcoes = tamRoupa;

            // clona template
            const tamanhos = document.getElementById("tamanhos");
            const clone = tamanhos.content.cloneNode(true);

            const select = clone.querySelector(".tamanho-select");
            const input = clone.querySelector(".estoque-input");

            // preenche tamanhos
            opcoes.forEach(t => {
                const o = document.createElement("option");
                o.value = t;
                o.textContent = t;
                select.appendChild(o);
            });

            // define names corretos para subir ao backend
            select.name = `Estoques[${index}].EstTamanho`;
            input.name  = `Estoques[${index}].EstQuantidade`;

            index++;

            document.getElementById("tamanho-div").appendChild(clone);
        });
    </script>
}