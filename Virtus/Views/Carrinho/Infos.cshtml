@model Virtus.Models.Carrinho

@if (TempData["Erro"] != null)
{
    <div class="alert alert-danger mt-3 fade show" role="alert">
        @TempData["Erro"]
    </div>
}

@if (ViewBag.ErroPagamento != null)
{
    <div class="alert alert-danger mt-3 fade show" role="alert">
        @ViewBag.ErroPagamento
    </div>
}



<form asp-action="FinalizarPedido" asp-controller="Carrinho" method="post">
    <div class="container my-4 fade-in">
        <h3 class="fw-bold mb-4 slide-down">Frete e pagamento</h3>

        <div class="row">
            <!-- Coluna esquerda -->
            <div class="col-md-8">
                <!-- Endereço -->
                <div class="mb-4 section-animate">
                    <h6 class="fw-bold">Endereço de Entrega</h6>
                    <div class="d-flex flex-column gap-2">
                        @if (Model.Enderecos.Count > 0)
                        {
                            int index = 0;
                            foreach (var endereco in Model.Enderecos)
                            {
                                <label class="card endereco-card p-3 border rounded-3 d-flex justify-content-between align-items-center hover-zoom">
                                    <div>
                                        <input class="form-check-input me-2" type="radio" name="EnderecoSelecionadoId" value="@endereco.Id" @(index == 0 ? "checked" : "") />
                                        <strong>@endereco.NomeCompleto</strong>: @($"{endereco.Logradouro}, {endereco.Numero} - {endereco.Cidade}/{endereco.Estado} - CEP {endereco.CEP}")
                                    </div>
                                </label>
                                index++;
                            }

                            <button type="button" class="btn btn-dark mt-3 smooth-btn"
                                    data-bs-toggle="modal" data-bs-target="#AdicionarEndereco">
                                Adicionar novo endereço
                            </button>
                        }
                        else
                        {
                            <button type="button" class="btn btn-outline-primary smooth-btn"
                                    data-bs-toggle="modal" data-bs-target="#AdicionarEndereco">
                                Escolher um endereço
                            </button>
                        }
                    </div>
                </div>

                <!-- Pagamento com cartão -->
                <h6 class="fw-bold mt-4 mb-3 slide-right">Pagar com cartão</h6>
                <div class="d-flex flex-column gap-2 mb-4 section-animate">
                    @if (Model.Cartoes != null && Model.Cartoes.Any())
                    {
                        foreach (var cartao in Model.Cartoes)
                        {
                            <label class="card cartao-card p-3 border rounded-3 d-flex justify-content-between align-items-center hover-zoom">
                                <div class="d-flex align-items-center gap-3">
                                    <input class="form-check-input me-2 metodo-pagamento" type="radio" name="MetodoPagamento" value="Cartão"
                                           onclick="selecionarCartao('@cartao.Id')" />
                                    <img src="/img/cartao.png" width="50" alt="Cartão" class="rounded" />
                                    <div>
                                        <div>@cartao.NomeTitular</div>
                                        <div class="text-muted small">@cartao.Bandeira - @cartao.Validade</div>
                                    </div>
                                </div>
                            </label>
                        }
                    }
                    else
                    {
                        <div class="text-muted">Nenhum cartão cadastrado.</div>
                    }

                    <input type="hidden" id="CartaoSelecionadoId" name="CartaoSelecionadoId" value="" />
                    <button class="btn btn-dark mt-3 smooth-btn" type="button" data-bs-toggle="modal" data-bs-target="#AdicionarCartao">
                        Adicionar outro cartão
                    </button>
                </div>

                <!-- PIX -->
                <h6 class="fw-bold mt-4 mb-3 slide-right">
                    <label class="d-flex justify-content-beetween align-items-center gap-2 card p-3 border rounded-3 pix-card hover-zoom">
                        <input class="form-check-input me-2 metodo-pagamento" type="radio" name="MetodoPagamento" id="pixRadio" value="Pix"
                               onclick="selecionarPix()" />
                        Pagar com Pix <img src="/img/pix-icon.png" width="18" alt="pix" />
                        <div class="p-2">
                            <h6 class="fw-bold">Ganhe 5% de desconto</h6>
                            <p class="small mb-1">1. Após a finalização do pedido, abra o app do seu banco e escolha pagar com Pix.</p>
                            <p class="small mb-1">2. Copie o código Pix ou escaneie o QR Code exibido.</p>
                            <p class="small mb-3">3. Você receberá a confirmação de pagamento por e-mail.</p>
                        </div>
                    </label>

                </h6>
            </div>

            <!-- Coluna direita -->
            <div class="col-md-4">
                <div class="border rounded-3 p-3 bg-light sticky-top slide-left" style="top:20px">
                    <h6 class="fw-bold">Resumo do pedido</h6>
                    <hr />

                    <div class="d-flex justify-content-between">
                        <span>Subtotal:</span>
                        <span id="subtotal">R$ @Model.Subtotal.ToString("F2")</span>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span>Frete:</span>
                        <span id="frete">R$ @Model.TaxaEntrega.ToString("F2")</span>
                    </div>
                    <hr />
                    <div class="d-flex justify-content-between fw-bold">
                        <span>Valor total:</span>
                        <span id="total">R$ @Model.Total.ToString("F2")</span>
                    </div>

                    <small class="text-muted">
                        ou R$ <span id="pixPrice">@Model.Pix.ToString("F2")</span> no pix com desconto de 5%
                    </small>

                    <button type="submit" class="btn btn-dark w-100 mt-3 smooth-btn">
                        Usar esse método de pagamento
                    </button>
                </div>
            </div>
        </div>
    </div>
</form>

<style>
    @@keyframes fadeIn {
        from

    {
        opacity: 0;
        transform: translateY(20px);
    }

    to {
        opacity: 1;
        transform: translateY(0);
    }

    }

    @@keyframes slideDown {
        from

    {
        opacity: 0;
        transform: translateY(-20px);
    }

    to {
        opacity: 1;
        transform: translateY(0);
    }

    }

    @@keyframes slideLeft {
        from

    {
        opacity: 0;
        transform: translateX(40px);
    }

    to {
        opacity: 1;
        transform: translateX(0);
    }

    }

    @@keyframes slideRight {
        from

    {
        opacity: 0;
        transform: translateX(-40px);
    }

    to {
        opacity: 1;
        transform: translateX(0);
    }

    }

    /* Classes utilitárias */
    .fade-in {
        animation: fadeIn 0.8s ease-in-out;
    }

    .slide-down {
        animation: slideDown 0.8s ease-in-out;
    }

    .slide-left {
        animation: slideLeft 1s ease-in-out;
    }

    .slide-right {
        animation: slideRight 1s ease-in-out;
    }

    .fade-up {
        animation: fadeIn 1s ease-in-out;
    }

    /* Cards e botões interativos */
    .hover-zoom {
        transition: transform 0.25s ease, box-shadow 0.25s ease;
        cursor: pointer;
    }

        .hover-zoom:hover {
            transform: scale(1.03);
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

    .smooth-btn {
        transition: all 0.3s ease;
    }

        .smooth-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 3px 8px rgba(0,0,0,0.15);
        }

    /* Efeito de destaque no card selecionado */
    input[type="radio"]:checked + strong,
    input[type="radio"]:checked ~ div {
        color: #0d6efd;
        font-weight: 600;
    }

    .section-animate {
        animation: fadeIn 1s ease both;
    }

        .section-animate:nth-child(1) {
            animation-delay: 0.1s;
        }

        .section-animate:nth-child(2) {
            animation-delay: 0.2s;
        }

        .section-animate:nth-child(3) {
            animation-delay: 0.3s;
        }

    .confirmando {
        background-color: #198754 !important;
        border-color: #198754 !important;
        transition: all 0.3s ease-in-out;
    }

        .confirmando:hover {
            background-color: #157347 !important;
            transform: scale(1.02);
        }

    .selected {
        border-color: #0d6efd !important;
        box-shadow: 0 0 10px rgba(13,110,253,0.4);
        transition: 0.3s;
    }

</style>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const metodoRadios = document.querySelectorAll('input[name="MetodoPagamento"]');
        const botao = document.querySelector('button[type="submit"].btn-dark.w-100');
        let etapaConfirmacao = false;

        // Seleção visual de cartões / pix
        metodoRadios.forEach(radio => {
            radio.addEventListener("change", () => {
                document.querySelectorAll('.pix-card, .cartao-card').forEach(c => c.classList.remove('selected'));
                radio.closest(".card").classList.add("selected");
            });
        });

        // Clique no botão principal
        botao.addEventListener("click", (e) => {
            const metodo = document.querySelector('input[name="MetodoPagamento"]:checked');

            if (!etapaConfirmacao) {
                e.preventDefault(); // bloqueia o submit no primeiro clique

                if (!metodo) {
                    mostrarErro("Por favor, selecione um método de pagamento antes de continuar.");
                    return;
                }

                // Muda para modo "Confirmar pedido"
                botao.textContent = "Confirmar pedido";
                botao.classList.add("confirmando");

                // Animação leve
                botao.animate(
                    [{ transform: "scale(1)" }, { transform: "scale(1.07)" }, { transform: "scale(1)" }],
                    { duration: 400, easing: "ease-in-out" }
                );

                etapaConfirmacao = true;
            } else {
                // Segundo clique → submete o formulário normalmente
                botao.textContent = "Processando...";
                botao.classList.add("disabled");
            }
        });

        // Função de erro visual (aparece e some depois)
        function mostrarErro(msg) {
            let alerta = document.getElementById("alertaErro");

            if (!alerta) {
                alerta = document.createElement("div");
                alerta.id = "alertaErro";
                alerta.className = "alert alert-danger mt-3 fade show";
                alerta.role = "alert";
                document.querySelector(".col-md-8").prepend(alerta);
            }

            alerta.textContent = msg;
            alerta.style.opacity = "1";
            alerta.animate([{ opacity: 0 }, { opacity: 1 }], { duration: 300, fill: "forwards" });

            // Some automaticamente após 3s
            setTimeout(() => {
                alerta.classList.remove("show");
                alerta.classList.add("fade");
            }, 3000);
        }
    });
</script>




<!-- Modal para adicionar endereço -->
<div class="modal fade" id="AdicionarEndereco" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5">Adicionar Endereço</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>

            <div class="modal-body">
                <form asp-action="SalvarEndereco" method="post">
                    <input type="hidden" name="Id" value="@Model.NovoEndereco.Id" />

                    <div class="row mb-2">
                        <label class="col-sm-4 col-form-label">Nome Completo</label>
                        <div class="col-sm-8">
                            <input class="form-control" name="NomeCompleto" value="@Model.NovoEndereco.NomeCompleto" />
                        </div>
                    </div>

                    <div class="row mb-2">
                        <label class="col-sm-4 col-form-label">Logradouro</label>
                        <div class="col-sm-8">
                            <input class="form-control" name="Logradouro" value="@Model.NovoEndereco.Logradouro" />
                        </div>
                    </div>

                    <div class="row mb-2">
                        <label class="col-sm-4 col-form-label">Número</label>
                        <div class="col-sm-8">
                            <input class="form-control" name="Numero" value="@Model.NovoEndereco.Numero" />
                        </div>
                    </div>

                    <div class="row mb-2">
                        <label class="col-sm-4 col-form-label">Bairro</label>
                        <div class="col-sm-8">
                            <input class="form-control" name="Bairro" value="@Model.NovoEndereco.Bairro" />
                        </div>
                    </div>

                    <div class="row mb-2">
                        <label class="col-sm-4 col-form-label">Cidade</label>
                        <div class="col-sm-8">
                            <input class="form-control" name="Cidade" value="@Model.NovoEndereco.Cidade" />
                        </div>
                    </div>

                    <div class="row mb-2">
                        <label class="col-sm-4 col-form-label">Estado</label>
                        <div class="col-sm-8">
                            <input class="form-control" name="Estado" value="@Model.NovoEndereco.Estado" />
                        </div>
                    </div>

                    <div class="row mb-2">
                        <label class="col-sm-4 col-form-label">CEP</label>
                        <div class="col-sm-8">
                            <input class="form-control" name="CEP" value="@Model.NovoEndereco.CEP" />
                        </div>
                    </div>

                    <div class="row mb-2">
                        <label class="col-sm-4 col-form-label">Complemento</label>
                        <div class="col-sm-8">
                            <input class="form-control" name="Complemento" value="@Model.NovoEndereco.Complemento" />
                        </div>
                    </div>

                    <div class="row">
                        <div class="offset-sm-4 col-sm-8">
                            <button type="submit" class="btn btn-primary">Salvar</button>
                        </div>
                    </div>
                </form>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>


<!-- Modal para adicionar cartão -->
<div class="modal fade" id="AdicionarCartao" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5">Adicionar Cartão</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>

            <div class="modal-body">
                <form asp-action="SalvarCartao" method="post">
                    <div class="mb-3">
                        <label class="form-label">Tipo</label>
                        <select name="Tipo" class="form-select" value="@Model.NovoCartao.Tipo" required>
                            <option value="">Selecione...</option>
                            <option>Crédito</option>
                            <option>Débito</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Nome no cartão</label>
                        <input type="text" name="NomeTitular" class="form-control" value="@Model.NovoCartao.NomeTitular" required  />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Número do cartão</label>
                        <input type="text" name="Numero" maxlength="16" class="form-control" value="@Model.NovoCartao.Numero" required />
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Validade (MM/AA)</label>
                            <input type="text" name="Validade" maxlength="5" class="form-control" placeholder="MM/AA" value="@Model.NovoCartao.Validade" required />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">CVV</label>
                            <input type="text" name="CVV" maxlength="3" class="form-control" value="@Model.NovoCartao.CVV" required />
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Bandeira</label>
                        <select name="Bandeira" class="form-select" value="@Model.NovoCartao.Bandeira" required>
                            <option value="">Selecione...</option>
                            <option>Mastercard</option>
                            <option>Visa</option>
                            <option>Elo</option>
                            <option>Hipercard</option>
                        </select>
                    </div>

                    <div class="text-end">
                        <button type="submit" class="btn btn-primary">Salvar cartão</button>
                    </div>
                </form>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>
