@model Virtus.Models.Carrinho
@{
    ViewData["Title"] = "Pagamento PIX";
    var codigoPix = "00020101021226870014br.gov.bcb.pix2556pix.exemplo.com/qr/v2/F64A495A29C43783475B183AE2959034ABB520400005039865802BR5905EBANX6008CURITIBA62070503***63047ABB";
}

<div class="container py-4">
    <div class="card shadow-sm border-2 border-warning-subtle rounded-3">
        <div class="card-body">
            <!-- Cabeçalho -->
            <div class="d-flex align-items-center mb-3">
                <i class="bi bi-exclamation-triangle-fill text-warning me-2 fs-4"></i>
                <h5 class="fw-semibold mb-0 text-warning">Pagamento via PIX</h5>
            </div>

            <p class="mb-1 text-muted">
                Vencimento em:
                <span id="contador" class="fw-semibold text-dark">30:00</span>
            </p>
            <p class="fw-semibold fs-5 mt-2">
                Valor do pedido<br>
                R$ @Model.ValorTotal.ToString("F2")
            </p>

            <hr class="my-3">

            <!-- QR CODE -->
            <div class="text-center mb-4">
                <img id="qrcodePix" src="/images/qrcode-pix.png" alt="QR Code Pix"
                     class="img-fluid border p-2 rounded-3 shadow-sm" style="max-width: 250px;">
            </div>

            <!-- Código PIX -->
            <div class="mb-3 text-center">
                <p class="fw-semibold mb-2">Em caso de erro, copie o código abaixo:</p>
                <div id="codigoPixContainer" class="bg-light border rounded p-2 text-break small mx-auto" style="max-width: 90%;">
                    @codigoPix
                </div>
                <button id="btnCopiarPix" class="btn btn-outline-warning btn-sm mt-3" onclick="copiarPix(event, '@codigoPix')">
                    Copiar código Pix
                </button>
            </div>

            <hr class="my-3">

            <!-- Informações adicionais -->
            <div class="text-muted small">
                <p class="fw-semibold mb-1">Informações importantes sobre o pagamento:</p>
                <p class="mb-0">
                    O pagamento deve ser realizado dentro do prazo de vencimento.
                    Caso não consiga pagar, copie o código Pix e tente novamente no seu app bancário.
                </p>
            </div>

            <!-- Botão de confirmação -->
            <div class="text-center mt-4">
                <form asp-action="ConfirmarPagamento" method="post">
                    <input type="hidden" name="pedidoId" value="@ViewBag.PedidoId" />

                    <button type="submit" class="btn btn-success w-100 mt-3">
                        Já realizei o pagamento
                    </button>
                </form>

            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Função: copiar código Pix
        function copiarPix(e, codigo) {
            navigator.clipboard.writeText(codigo);
            const btn = e.target;
            btn.innerText = "Copiado!";
            btn.classList.remove("btn-outline-warning");
            btn.classList.add("btn-success");
            setTimeout(() => {
                btn.innerText = "Copiar código Pix";
                btn.classList.remove("btn-success");
                btn.classList.add("btn-outline-warning");
            }, 2000);
        }

        // Função: contador regressivo de 30 minutos
        const tempoTotal = 30 * 60; // 30 minutos em segundos
        let tempoRestante = tempoTotal;

        const contador = document.getElementById("contador");
        const qrcode = document.getElementById("qrcodePix");
        const btnCopiar = document.getElementById("btnCopiarPix");
        const codigoPixContainer = document.getElementById("codigoPixContainer");

        const timer = setInterval(() => {
            const minutos = Math.floor(tempoRestante / 60);
            const segundos = tempoRestante % 60;
            contador.textContent = `${String(minutos).padStart(2, '0')}:${String(segundos).padStart(2, '0')}`;

            // Quando o tempo acabar
            if (tempoRestante <= 0) {
                clearInterval(timer);
                contador.textContent = "Expirado";
                contador.classList.add("text-danger");
                qrcode.style.opacity = "0.4";
                btnCopiar.disabled = true;
                btnCopiar.classList.remove("btn-outline-warning");
                btnCopiar.classList.add("btn-secondary");
                btnCopiar.innerText = "Expirado";
                codigoPixContainer.classList.add("bg-secondary", "text-white");
            }

            tempoRestante--;
        }, 1000);
    </script>
}

<style>
    .border-warning-subtle {
        border-color: #ffc10755 !important;
    }
</style>
